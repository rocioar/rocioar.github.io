<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Optimizing Django ORM Queries :: roschegel — Rocio&#39;s blog about programming.</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="The Django ORM (Object Relational Mapping) is one of the most powerful features of Django. It enables us to interact with the database using Python code instead of SQL.
It has multiple advantages:
 The database engine is abstracted from us, so it is possible to switch to another database system with ease. It supports migrations: we can easily change our tables by updating our models and Django will automatically generate the migration scripts needed to update the database tables." />
<meta name="keywords" content="Django, Django ORM Optimization, Django ORM" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/optimizing-django-orm-queries/" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-165430966-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/blue.css">



<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/img/favicon/blue.png">



<meta name="twitter:card" content="summary" />

  <meta name="twitter:site" content="roschegel" />

<meta name="twitter:creator" content="Rocio Aramberri" />


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Optimizing Django ORM Queries :: roschegel">
<meta property="og:description" content="The Django ORM (Object Relational Mapping) is one of the most powerful features of Django. It enables us to interact with the database using Python code instead of SQL.
It has multiple advantages:
 The database engine is abstracted from us, so it is possible to switch to another database system with ease. It supports migrations: we can easily change our tables by updating our models and Django will automatically generate the migration scripts needed to update the database tables." />
<meta property="og:url" content="/posts/optimizing-django-orm-queries/" />
<meta property="og:site_name" content="Optimizing Django ORM Queries" />

  
    <meta property="og:image" content="/img/favicon/blue.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2020-05-03 00:00:00 &#43;0000 UTC" />









<meta property="og:image" content="/img/photo.jpg">
<meta name="twitter:image" content="/img/photo.jpg">


</head>
<body class="">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    roschegel
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/">Posts</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/">Posts</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/optimizing-django-orm-queries/">Optimizing Django ORM Queries</a></h1>
  <div class="post-meta">
      
    <span class="post-date">
      2020-05-03
    </span>
    
    
    <span class="post-author">::
      Rocio Aramberri
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/python/">python</a>&nbsp;
    
    #<a href="/tags/django/">django</a>&nbsp;
    
  </span>
  

  

  <div class="post-content"><div>
        <p>The Django ORM (Object Relational Mapping) is one of the most powerful features of Django. It enables us to interact with the database using Python code instead of SQL.</p>
<p>It has multiple advantages:</p>
<ul>
<li>The database engine is abstracted from us, so it is possible to switch to another database system with ease.</li>
<li>It supports <a href="https://docs.djangoproject.com/en/3.0/topics/migrations/">migrations</a>: we can easily change our tables by updating our models and Django will automatically generate the migration scripts needed to update the database tables.</li>
<li>It supports <a href="https://docs.djangoproject.com/en/3.0/topics/db/transactions/">transactions</a>: you can make multiple updates to the database within a transaction and, if something fails, roll it back to the way it was when you started.</li>
</ul>
<p>But it also comes with some disadvantages:</p>
<ul>
<li>Since it is an abstraction on top of SQL, it is obscure, and we don’t know exactly which SQL queries will be generated from our Python code.</li>
<li>Django has no way to guess when we will need to use a related table, so it won’t do JOINs for us when we need them.</li>
<li>The ORM gives us the wrong sensation that what we are doing is not expensive. We have no easy way to know that accessing an attribute in an object might trigger a query to the database that could have been prevented with a JOIN.</li>
</ul>
<p>To overcome the disadvantages we need to become more acquainted with it and understand what is happening under the hood.</p>
<h2 id="find-out-whats-happening-under-the-hood">Find out what’s happening under the hood<a href="#find-out-whats-happening-under-the-hood" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>First, we need to understand what is happening in our system, which SQL queries are being run, and what’s costing us the most.</p>
<p>Here are some different mechanisms to inspect SQL queries as they are executed:</p>
<h4 id="1-connectionqueries">1. connection.queries<a href="#1-connectionqueries" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>When <code>debug=True</code>, it is possible to access the queries that have been executed by printing <code>connection.queries</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> connection
<span style="color:#f92672">&gt;&gt;&gt;</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
<span style="color:#f92672">&gt;&gt;&gt;</span> connection<span style="color:#f92672">.</span>queries
[
   {
      <span style="color:#e6db74">&#39;sql&#39;</span>: <span style="color:#e6db74">&#39;SELECT &#34;blogposts_post&#34;.&#34;id&#34;, &#34;blogposts_post&#34;.&#34;title&#34;, &#39;</span>
             <span style="color:#e6db74">&#39;&#34;blogposts_post&#34;.&#34;content&#34;, &#34;blogposts_post&#34;.&#34;blog_id&#34;, &#39;</span>
             <span style="color:#e6db74">&#39;&#34;blogposts_post&#34;.&#34;published&#34; FROM &#34;blogposts_post&#34; LIMIT 21&#39;</span>,
      <span style="color:#e6db74">&#39;time&#39;</span>: <span style="color:#e6db74">&#39;0.000&#39;</span>
   }
]
</code></pre></div><p><code>connection.queries</code> holds a list of SQL queries in the form of dictionaries containing the SQL code and the time it took to run.</p>
<p>The queries list could get convoluted very easily. To fix that, Django provides a way to clean them up:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> reset_queries
<span style="color:#f92672">&gt;&gt;&gt;</span> reset_queries()
</code></pre></div><h4 id="2-shell_plus---print-sql">2. shell_plus &ndash;print-sql<a href="#2-shell_plus---print-sql" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>The <a href="https://github.com/django-extensions/">django-extensions</a> project is great and comes with a handful of useful features.</p>
<p><code>shell_plus</code> is one of them. It’s a Django shell with extra additions. If you call it with the <code>--print-sql</code> parameter, it will print the SQL queries as they are executed when you run your code.</p>
<p>I will use <code>shell_plus</code> throughout this post so that you can see the SQL queries that are being executed as the code is ran.</p>
<p>Here is a quick example of how the output would look like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#f92672">./</span>manage<span style="color:#f92672">.</span>py shell_plus <span style="color:#f92672">--</span><span style="color:#66d9ef">print</span><span style="color:#f92672">-</span>sql
<span style="color:#f92672">&gt;&gt;&gt;</span> post <span style="color:#f92672">=</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
     	<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
ORDER BY <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> ASC
LIMIT <span style="color:#ae81ff">1</span>
</code></pre></div><h4 id="3-django-silk">3. django-silk<a href="#3-django-silk" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><a href="https://github.com/jazzband/django-silk">django-silk</a> is a profiling tool. It intercepts requests, records the SQL queries that were performed, and provides a way to visualize them.</p>
<p>You will be able to browse through the requests, see a list of SQL queries that were performed, and look at the details about a specific query including which line of code caused a certain query to run.</p>
<h4 id="4-django-debug-toolbar">4. django-debug-toolbar<a href="#4-django-debug-toolbar" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><a href="https://github.com/jazzband/django-debug-toolbar">django-debug-toolbar</a> adds a toolbar on your browser that will show you lots of debugging information while you browse your Django project. Using it, you can see the number of SQL queries that were performed on a request. It is also possible to inspect these queries further, check the SQL code and see in which order they were performed and how much time each one took.</p>
<h2 id="optimize-your-queries">Optimize your queries<a href="#optimize-your-queries" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="introducing-an-example-database-model">Introducing an Example Database Model<a href="#introducing-an-example-database-model" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>We will use the following database models as an example for the upcoming sections:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Blog</span>(models<span style="color:#f92672">.</span>Model):
   name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">250</span>)
   url <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>URLField()

   <span style="color:#66d9ef">def</span> __str__(self):
       <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>name


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Author</span>(models<span style="color:#f92672">.</span>Model):
   name <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">250</span>)
   email <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>EmailField()

   <span style="color:#66d9ef">def</span> __str__(self):
       <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>name


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Post</span>(models<span style="color:#f92672">.</span>Model):
   title <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">250</span>)
   content <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>TextField()
   published <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>BooleanField(default<span style="color:#f92672">=</span>False)

   blog <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ForeignKey(Blog, on_delete<span style="color:#f92672">=</span>models<span style="color:#f92672">.</span>CASCADE)
   authors <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ManyToManyField(Author, related_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;posts&#34;</span>)

   <span style="color:#66d9ef">def</span> __str__(self):
       <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>title
</code></pre></div><h3 id="use-cached-foreign-key-ids">Use cached Foreign Key ids<a href="#use-cached-foreign-key-ids" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>If we just need to access the <code>id</code> of a <code>ForeignKey</code> field, we can use the cached id that Django already has cached for us via <code>&lt;field_name&gt;_id</code>.</p>
<p>Let see it through an example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>first()<span style="color:#f92672">.</span>blog<span style="color:#f92672">.</span>id
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
ORDER BY <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> ASC
LIMIT <span style="color:#ae81ff">1</span>

Execution time: <span style="color:#ae81ff">0.001668</span>s [Database: default]
SELECT <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;url&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_blog&#34;</span>
WHERE <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000197</span>s [Database: default]
</code></pre></div><p>Accessing the blog&rsquo;s <code>id</code> through the nested object <code>blog</code> generated a new SQL query to obtain the entire blog object. But since we won’t need to access any other attribute from the blog object, we could completely avoid the above query from being executed by doing:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>first()<span style="color:#f92672">.</span>blog_id
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
ORDER BY <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> ASC
LIMIT <span style="color:#ae81ff">1</span>

Execution time: <span style="color:#ae81ff">0.000165</span>s [Database: default]
</code></pre></div><h3 id="let-django-know-what-you-will-need-in-advance">Let Django know what you will need in advance<a href="#let-django-know-what-you-will-need-in-advance" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="use-select_related-for-foreign-keys">Use select_related for Foreign Keys<a href="#use-select_related-for-foreign-keys" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Django has no way of anticipating when we will need to access a <code>ForeignKey</code> relationship from within the model we are querying. The <a href="https://docs.djangoproject.com/en/3.0/ref/models/querysets/#select-related">select_related</a> utility allows us to tell Django exactly which related models we want, so that it can perform JOINs.</p>
<p>In our example, we have a <code>Post</code> model. A <code>Post</code> belongs to a specific <code>Blog</code>. This relationship is represented on the database through a <code>ForeignKey</code> from the <code>Post</code> to the <code>Blog</code>.</p>
<p>To access a specific <code>Post</code> object we could do:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> post <span style="color:#f92672">=</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
ORDER BY <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> ASC
LIMIT <span style="color:#ae81ff">1</span>
</code></pre></div><p>If we wanted to access the <code>Blog</code> object from within the <code>Post</code>, we could do:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> post<span style="color:#f92672">.</span>blog
SELECT <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;url&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_blog&#34;</span>
WHERE <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000602</span>s [Database: default]
<span style="color:#f92672">&lt;</span>Blog: Rocio<span style="color:#e6db74">&#39;s Blog&gt;</span>
</code></pre></div><p>However, this statement generated a new query to grab the information from the blog. We want to avoid that. This is when <code>select_related</code> comes to our rescue. To use it we can update our original query to be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> post <span style="color:#f92672">=</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#34;blog&#34;</span>)<span style="color:#f92672">.</span>get(id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;url&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_blog&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>)
WHERE <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000150</span>s [Database: default]
</code></pre></div><p>Notice now how Django used a <code>JOIN</code> on the SQL query above to also grab the attributes from the blog table for us. Now, when accessing the <code>Blog</code> object from within the <code>Post</code>, it will not require an extra query since it will already be cached:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> post<span style="color:#f92672">.</span>blog
<span style="color:#f92672">&lt;</span>Blog: Rocio<span style="color:#e6db74">&#39;s Blog&gt;</span>
</code></pre></div><p><code>select_related</code> also works for querysets. We could pre-select the blog object for an entire queryset. If there were 50 Posts and we didn’t use <code>select_related</code> to pre-select the blog object, it would take Django 50 queries to run the following code. With <code>select_related</code> it just takes one:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> posts <span style="color:#f92672">=</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>select_related(<span style="color:#e6db74">&#34;blog&#34;</span>)<span style="color:#f92672">.</span>all()
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> post <span style="color:#f92672">in</span> posts:
       post<span style="color:#f92672">.</span>blog

SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;url&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_blog&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_blog&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>)

Execution time: <span style="color:#ae81ff">0.000224</span>s [Database: default]
</code></pre></div><h4 id="use-prefetch_related-for-manytomany-fields">Use prefetch_related for ManyToMany fields<a href="#use-prefetch_related-for-manytomany-fields" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><a href="https://docs.djangoproject.com/en/3.0/ref/models/querysets/#prefetch-related">prefetch_related</a> is similar to <code>select_related</code>, but it is used for pre-selecting <code>ManyToMany</code> fields. <code>prefetch_related</code> works differently, let’s see it through an example.</p>
<p>Let’s say we wanted to grab all the Posts and then print the Authors for each of the Posts. We could do the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> post <span style="color:#f92672">in</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all():
       post<span style="color:#f92672">.</span>authors<span style="color:#f92672">.</span>all()

SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>

Execution time: <span style="color:#ae81ff">0.000158</span>s [Database: default]
<span style="color:#f92672">&lt;</span>QuerySet []<span style="color:#f92672">&gt;</span>
SELECT <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;email&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_author&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span>)
WHERE <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000101</span>s [Database: default]
<span style="color:#f92672">&lt;</span>QuerySet []<span style="color:#f92672">&gt;</span>
SELECT <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;email&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_author&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span>)
WHERE <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
LIMIT <span style="color:#ae81ff">21</span>
Execution time: <span style="color:#ae81ff">0.001043</span>s [Database: default]

Execution time: <span style="color:#ae81ff">0.000101</span>s [Database: default]
<span style="color:#f92672">&lt;</span>QuerySet []<span style="color:#f92672">&gt;</span>
SELECT <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;email&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_author&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span>)
WHERE <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
LIMIT <span style="color:#ae81ff">21</span>
Execution time: <span style="color:#ae81ff">0.001043</span>s [Database: default]
</code></pre></div><p>Notice that the code above generated 4 queries, one to grab the posts, and then one query for each of the posts to grab the authors (there were 3 posts in total).</p>
<p>This is the famous N + 1 problem. Given N posts, N + 1 queries will be performed. In this scenario we have 3 posts, which translate to 4 queries. It isn’t that much, but this could very easily escalate as we create new Posts. With 50 Posts, this code would generate 51 queries.</p>
<p>To avoid that, we could pre-select the Authors by using <code>prefetch_related</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> post <span style="color:#f92672">in</span> Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>prefetch_related(<span style="color:#e6db74">&#34;authors&#34;</span>)<span style="color:#f92672">.</span>all():
       post<span style="color:#f92672">.</span>authors<span style="color:#f92672">.</span>all()

SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>

Execution time: <span style="color:#ae81ff">0.000158</span>s [Database: default]
SELECT (<span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span>) AS <span style="color:#e6db74">&#34;_prefetch_related_val_post_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;email&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_author&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span>)
WHERE <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span> IN (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)

Execution time: <span style="color:#ae81ff">0.001043</span>s [Database: default]
</code></pre></div><p>With our updated code only 2 queries were performed. When <code>prefetch_related</code> is used, Django first grabs all the posts and then runs another SQL query that retrieves all the authors for all the posts.</p>
<h4 id="customizing-prefetch">Customizing Prefetch<a href="#customizing-prefetch" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>In some scenarios <code>prefetch_related</code> basic syntax is not enough to prevent Django from doing extra queries. To further control the prefetch you can use the <code>Prefetch</code> object.</p>
<p>In our example database, there is a <code>Post</code> model and an <code>Author</code> model. The <code>Post</code> model is related to the <code>Author</code> model through a <code>ManyToMany</code> field. Let’s say we wanted to go author by author and grab all the posts that were published by that author:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> authors <span style="color:#f92672">=</span> Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>all()
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> author <span style="color:#f92672">in</span> authors:
       <span style="color:#66d9ef">print</span>(author<span style="color:#f92672">.</span>posts<span style="color:#f92672">.</span>filter(published<span style="color:#f92672">=</span>True))

SELECT <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;email&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_author&#34;</span>

Execution time: <span style="color:#ae81ff">0.000251</span>s [Database: default]
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span>)
WHERE (<span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> AND <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000178</span>s [Database: default]
<span style="color:#f92672">&lt;</span>QuerySet [<span style="color:#f92672">&lt;</span>Post: Optimizing Django ORM Queries<span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post<span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">3</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">7</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span>]<span style="color:#f92672">&gt;</span>
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span>)
WHERE (<span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> AND <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000081</span>s [Database: default]
<span style="color:#f92672">&lt;</span>QuerySet [<span style="color:#f92672">&lt;</span>Post: Optimizing Django ORM Queries<span style="color:#f92672">&gt;</span>]<span style="color:#f92672">&gt;</span>
</code></pre></div><p>As you can see, the above code generated 3 queries, 1 to grab the author, and then 2 queries to grab the posts for each of the authors.</p>
<p>What if we used <code>prefetch_related</code>? It seems to be the right thing to do:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> authors <span style="color:#f92672">=</span> Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>prefetch_related(<span style="color:#e6db74">&#34;posts&#34;</span>)<span style="color:#f92672">.</span>all()
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> author <span style="color:#f92672">in</span> authors:
       <span style="color:#66d9ef">print</span>(author<span style="color:#f92672">.</span>posts<span style="color:#f92672">.</span>filter(published<span style="color:#f92672">=</span>True))

SELECT <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;email&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_author&#34;</span>

Execution time: <span style="color:#ae81ff">0.000097</span>s [Database: default]
SELECT (<span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span>) AS <span style="color:#e6db74">&#34;_prefetch_related_val_author_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span>)
WHERE <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span> IN (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)

Execution time: <span style="color:#ae81ff">0.000190</span>s [Database: default]
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span>)
WHERE (<span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> AND <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000074</span>s [Database: default]
<span style="color:#f92672">&lt;</span>QuerySet [<span style="color:#f92672">&lt;</span>Post: Optimizing Django ORM Queries<span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post<span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">3</span><span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">7</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span>]<span style="color:#f92672">&gt;</span>
SELECT <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span>)
WHERE (<span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> AND <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
LIMIT <span style="color:#ae81ff">21</span>

Execution time: <span style="color:#ae81ff">0.000070</span>s [Database: default]
<span style="color:#f92672">&lt;</span>QuerySet [<span style="color:#f92672">&lt;</span>Post: Optimizing Django ORM Queries<span style="color:#f92672">&gt;</span>]<span style="color:#f92672">&gt;</span>
</code></pre></div><p>What did just happen? We used <code>prefetch_related</code> to reduce the number of queries, and we actually increased it by 1.</p>
<p>This is happening because we are filtering the posts with <code>published=True</code>. Django can’t use our cached posts since they were not filtered when they were queried. To avoid this from happening, we can customize the queryset using the <code>Prefetch</code> object:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> authors <span style="color:#f92672">=</span> Author<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>prefetch_related(
       Prefetch(
          <span style="color:#e6db74">&#34;posts&#34;</span>,
          queryset<span style="color:#f92672">=</span>Post<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(published<span style="color:#f92672">=</span>True),
          to_attr<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;published_posts&#34;</span>,
       )
    )
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> author <span style="color:#f92672">in</span> authors:
      <span style="color:#66d9ef">print</span>(author<span style="color:#f92672">.</span>published_posts)

SELECT <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;name&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_author&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;email&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_author&#34;</span>

Execution time: <span style="color:#ae81ff">0.000129</span>s [Database: default]
SELECT (<span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span>) AS <span style="color:#e6db74">&#34;_prefetch_related_val_author_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;title&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;content&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;blog_id&#34;</span>,
      <span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span>
 FROM <span style="color:#e6db74">&#34;blogposts_post&#34;</span>
INNER JOIN <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span>
   ON (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;post_id&#34;</span>)
WHERE (<span style="color:#e6db74">&#34;blogposts_post&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;published&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> AND <span style="color:#e6db74">&#34;blogposts_post_authors&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;author_id&#34;</span> IN (<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>))

Execution time: <span style="color:#ae81ff">0.000089</span>s [Database: default]
[<span style="color:#f92672">&lt;</span>Post: Optimizing Django ORM Queries<span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post<span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">3</span><span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">7</span><span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span>,
<span style="color:#f92672">&lt;</span>Post: Placeholder Post <span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span>]
[<span style="color:#f92672">&lt;</span>Post: Optimizing Django ORM Queries<span style="color:#f92672">&gt;</span>]
</code></pre></div><p>We used the <code>Prefetch</code> object to tell Django to:</p>
<ul>
<li>Use a specific queryset to retrieve the posts - through the <code>queryset</code> parameter.</li>
<li>Store the filtered posts in a new attribute (<code>published_posts</code>) - through the <code>to_attr</code> parameter.</li>
</ul>
<p>When <code>author.published_posts</code> is executed, no queries will be run since everything will already be cached. No matter the number of authors on our system, the operation will always take 2 SQL queries.</p>
<h2 id="wrapping-up">Wrapping up<a href="#wrapping-up" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>While working with the Django ORM, it is extremely important that we think about what’s happening under the hood.</p>
<p>The concepts that you learned on this blog post will help you write more optimized queries and be in the lookout for possible optimizations while reviewing code. Beware though, that you should always measure the time a query is taking before and after the optimization to ensure that the optimization worked. Sometimes less queries doesn&rsquo;t necessairly mean less time, JOINs could be expensive too.</p>

      </div></div>

  
  
  

  

  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "roschegel" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>By Rocio Aramberri</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>





  
</div>

</body>
</html>
